\documentclass[a4paper,
               %boxit,        % check whether paper is inside correct margins
               %titlepage,    % separate title page
               %refpage       % separate references
               biblatex,     % biblatex is used
               keeplastbox,   % flushend option: not to un-indent last line in References
               %nospread,     % flushend option: do not fill with whitespace to balance columns
               %hyphens,      % allow \url to hyphenate at "-" (hyphens)
               %xetex,        % use XeLaTeX to process the file
               %luatex,       % use LuaLaTeX to process the file
               ]{jacow}
%
% ONLY FOR \footnote in table/tabular
%
\usepackage{pdfpages,multirow,ragged2e} %
%
% CHANGE SEQUENCE OF GRAPHICS EXTENSION TO BE EMBEDDED
% ----------------------------------------------------
% test for XeTeX where the sequence is by default eps-> pdf, jpg, png, pdf, ...
%    and the JACoW template provides JACpic2v3.eps and JACpic2v3.jpg which
%    might generates errors, therefore PNG and JPG first
%
\makeatletter%
	\ifboolexpr{bool{xetex}}
	 {\renewcommand{\Gin@extensions}{.pdf,%
	                    .png,.jpg,.bmp,.pict,.tif,.psd,.mac,.sga,.tga,.gif,%
	                    .eps,.ps,%
	                    }}{}
\makeatother

% CHECK FOR XeTeX/LuaTeX BEFORE DEFINING AN INPUT ENCODING
% --------------------------------------------------------
%   utf8  is default for XeTeX/LuaTeX
%   utf8  in LaTeX only realises a small portion of codes
%
\ifboolexpr{bool{xetex} or bool{luatex}} % test for XeTeX/LuaTeX
 {}                                      % input encoding is utf8 by default
 {\usepackage[utf8]{inputenc}}           % switch to utf8

\usepackage[USenglish]{babel}

%
% if BibLaTeX is used
%
\ifboolexpr{bool{jacowbiblatex}}%
 {%
  \addbibresource{references.bib}
  \addbibresource{references_extra.bib}
 }{}
\listfiles

%%
%%   Lengths for the spaces in the title
%%   \setlength\titleblockstartskip{..}  %before title, default 3pt
%%   \setlength\titleblockmiddleskip{..} %between title + author, default 1em
%%   \setlength\titleblockendskip{..}    %afterauthor, default 1em

\begin{document}

\title{Beam optics modelling through fringe fields during injection and extraction at the CERN Proton Synchrotron}

\author{E. P. Johnson\thanks{eliott.philippe.johnson@cern.ch}, M. A. Fraser, M. G. Atanasov, Y. Dutheil, E. Oponowicz,\\ CERN, 1211 Geneva 23, Switzerland}
	
\maketitle

%
\begin{abstract}
As the beam is injected and extracted from the CERN Proton Synchrotron (PS) it passes through the fringing magnetic fields of the Main bending Units (MUs). In this study, tracking simulations using field maps created from a 3D magnetic model of the MUs are compared to beam-based measurements made through the fast injection and slow extraction regions. The behavior of the fringe field is characterized, and its implementation in the MAD-X \cite{noauthor_mad_nodate} model of the machine is described.
\end{abstract}


\section{Introduction}
When protons and ion beams are injected and extracted into the PS ring, they travel through the non-linear stray fields produced by the PS MUs. In these regions, an accurate optical model is imperative to ensure high transmission and preservation of transverse emittance. Scaling of the model with energy is required as the injection occurs at 2 GeV, and the extractions to the East Area and to the Super Proton Sychrotron (SPS) are at 24 GeV and 26 GeV, respectively. The stray field depends on the level of saturation in the MU and must be included in the model to accurately parameterise the effect on the beam over the wide range of beam energies provided by the PS. The model will be exploited for the Charm High-energy Ions for Micro Electronics Reliability Assurance (CHIMERA) project, which aims to deliver heavy-ion beams over a wide range of energies to study the effect of single event effects on electric, electronic, and electromechanical devices, both for research and industry users \cite{fraser:ipac22-wepost012}.

\section{Field maps}
\subsection{PS Main Units}
The CERN PS is composed of 100 combined-function MU magnets that produce dipolar and quadrupolar fields simultaneously to provide strong focusing. Each magnet is divided into two half-units with quadrupole gradients of opposite polarity. Half-units are composed of five blocks of either closed blocks that are focusing (F) or open blocks that are defocusing (D), see Fig.\ref{fig:streamplot}.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{streamplot_defocusing_focusing.png}
   \caption{Vector flow of an open defocusing yoke (left) and a closed focusing yoke (right)}
   \label{fig:streamplot}
\end{figure}

There are four types of magnets: R, S, T and U, depending on the arrangement of the half-units (FD or DF) and whether the main coil is on the inside or outside of the ring \cite{steerenberg_fifty_2011}. Additional coils named the Pole Face Windings (PFW) and Figure-of-eight Loop (F8L) are inserted between the yoke and the vacuum chamber to control the tune and chromaticity. Although the good field region of the combined function magnet extends over a large part of the magnet aperture around the circulating beam orbit, see Fig.~\ref{fig:gradient_field}, the injection and extraction trajectory of the beam travels through strong regions of fringing or stray field. This is a consequence of the PS not being built with straight sections long enough for injection/extraction at high energy, forcing the extracted beam to travel through the stray fields of the MUs \cite{risselada_beam_nodate}.

\subsection{The OPERA model}
A finite element magnetic model of the PS MU was developed using Cobham's \texttt{Opera-3D}~\cite{noauthor_opera_nodate, anglada_pxmu_hrcwp_nodate} to generate field maps for all four types of magnets and for different excitation currents in the main coils, as well as in the PFW and F8L. The model includes the main junction gap of 20 mm (a significant source of fringe field) between the two half units as well as the mini junctions between open blocks of 9.75 mm and 7.75 mm between closed blocks. A plane containing the geometry of open and closed yokes is swept in the longitudinal direction, allowing us to maintain high accuracy of the model, and reduces the computation time. This feature of a single plane also has limitations as it models straight magnets, while real magnets have a curvature. The density of the mesh is adjusted so that it has a high resolution in close proximity to the central orbit and at the junctions to capture the fringe fields \cite{anglada_reference_2019}.

An example of vector field map ($B_x$, $B_y$, $B_z$) in a Cartesian coordinate system ($x$,$y$,$z$) produced by the \texttt{Opera-3D} model is presented in Fig.~\ref{fig:dipole_field}. The transverse displacement of the peak of the vertical dipole field $B_{y}$ along the z-axis corresponds to the switch from one half-unit to the next. The resolution of the field map is high enough to see the mini-junction between the five blocks. The \texttt{Opera-3D} model can be exploited to generate field maps at different energies, different PFW, different F8L settings, and for the different magnet types. 

\begin{figure}[!htb]
   \centering
   %trim={<left> <lower> <right> <upper>}
   \includegraphics*[width=1.0\columnwidth, trim={0 2.9cm 0 4.3cm},clip]{MOPOTK030_f3.png}
   \caption{Dipole field map of a U-type magnet centered in the vertical plane at 24 GeV.}
   \label{fig:dipole_field}
\end{figure}

The gradient can be calculated from the dipole field map using the following formula:
 
$$ \boldsymbol{G}(x_{j},z) = \frac{\Delta\boldsymbol{B}}{\Delta x} = \frac{\boldsymbol{B}(x_{i+1},z) - \boldsymbol{B}(x_{i},z)}{x_{i+1}-x_{i}} $$
where,
$$ x_{j} = \frac{x_{i+1} + x_{i}}{{2}} $$
 
 As shown in Fig.~\ref{fig:gradient_field}, the gradient is constant and alternating in the central orbit region, but reverses signs at the periphery and increases in magnitude in a non-linear way.  In this region centered around 0 m and of total width of \char`\~0.144 m, the gradient is constant within 5\% of the center gradient.


\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth, trim={0 0 0 0cm},clip]{Main_field_B_G_with_mask.png}
   \caption{Dipole and gradient component of a  PS U-type MU centered in the vertical plane in both half-units at 24 GeV. The gradient outside the green-shaded central orbit is non-linear and, at its maximum, is almost three-fold higher in amplitude.}
   \label{fig:gradient_field}
\end{figure}

\subsection{Beam Tracking}

Particle tracking through field maps is done using the Boris algorithm that tracks charged particles in EM-fields using the discretized equation of motion of the Lorentz force \cite{dutheil_pybttrackersborispy_nodate,qin_why_2013,ripperda_comprehensive_2018}. Field maps were produced for each magnet type at three different energies: injection at 2 GeV with 533 A, slow extraction to the east area at 24 GeV with 4642 A, and extraction to the SPS at 26.4 GeV with 5386 A. In the following, measurements and tracking studies of injection from the BTP transfer line to the PS and extraction from the PS to the East Area are discussed

\section{Injection via BTP}
As the beam is injected via the BTP transfer line to the PS ring, it passes through the stray fields of the PR.BHT41 T-type MU magnet. The beam traverses mostly through the defocusing half part and feels a non-linear increase in the gradient up to the nominal value in the central orbit. Once through MU41, the beam is deflected by the injection septum magnet (PI.SMH42) towards the central orbit, see Fig.~\ref{fig:injection_btp}. Immediately downstream of the septum a Secondary Emission Grid (PI.BSG42) is available to measure the beam position and size.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{MOPOTK030_f5.png}
   \caption{Tracking through MU41 T-type at 2 GeV.}
   \label{fig:injection_btp}
\end{figure}

To test the model measurements of the beam position and size on PI.BSG42 were collected as the current provided by the main power supply (POPS) to the MUs was varied. As expected, an increasing current shows the transverse position of the beam is bent closer towards the inside of the ring by the stronger stray field. The measurements were compared to simulations tracking a single particle through the 2 GeV T-type field map presented in Fig.~\ref{fig:injection_btp_transverse_position}. The tracking simulation over estimates the effect of the stray field because the magnetic model does not yet include the mu-metal shielding wrapped around the injection vacuum pipe. As expected, no deviation was observed in the vertical plane.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{transverse_position_vs_POPS.png}
   \caption{Measurements of the BT3 BTP PS kick response as a function of POPS at PI.BSG42 compared with the OPERA tracking model.}
   \label{fig:injection_btp_transverse_position}
\end{figure}

The stray field was implemented into the MAD-X model as a sequence of multipole field components (MFC model) expanded along the reference trajectory. A simplified approach with the fields components extracted on an injected trajectory assumed as straight line was compared with measurements in Fig.~\ref{fig:injection_btp_beam_size}, where the beam size at PI.BSG42 is plotted as a function of the POPS current. We find good agreement in the horizontal plane but a mismatch in the vertical plane. A quadrupole scan of this region was performed and an analysis will tell us whether this is the result of incorrect initial parameters.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{Beam_size_vs_POPS.png}
   \caption{Measurements of the BT3 BTP PS beam size as a function of POPS at PI.BSG42 compared with the MCP model.}
   \label{fig:injection_btp_beam_size}
\end{figure}

\section{Extraction to the East Area}
The beam extracted to the East Area is significantly affected by the stray fields in multiple main units because the slow extracted trajectory at high energy has a much shallower angle than at injection. As presented in Fig.~\ref{fig:stray field gradients}, the difference in the gradient of MU62 is remarkable where the sign of the gradient flips and triples in amplitude. As a result, an increase in the horizontal beam size is expected at the exit of MU62. It is not understood why this magnet was never shimmed in the past to help reduce the effect of the stray field, but it is undoubtedly the cause of the optics discrepancy observed during commissioning of the East Area transfer lines in 2021 \cite{huschauer:ipac22-mopost006}.

\textbf{Add your simple bar chart gradient comparison here: perhaps don't include MU63}

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{gradient_focusing.png}
   \caption{Gradient seen by the slow extracted beam in the stray field of the MUs. A succession in defocusing gradients at extraction is observed.}
   \label{fig:stray field gradients}
\end{figure}

\subsection{Magnetic shims}

To counteract stray fields, magnetic shims are installed in MU16 (fast extraction to SPS) and MU63 (slow extraction to East Area) to homogenize the field by shielding the ejected beam from the non-linear fringe field \cite{zickler_influence_nodate}. In MU16, the shims have different radial positions for each of the five different shims, whereas in MU63, the vacuum pipe is covered with a constant rectangular shim. In MU62, no shims are installed, where the model predicts the most important stray field effect. In a next step the shim geometry will be incorporated into the \texttt{OPERA-3D} model, which will significantly increase the computation time of the finite element solver due to the increased complexity of the geometries.

\subsection{Measurement of the extracted beam parameters}

Quadrupole scans through the stray fields have been made using a combination of quadrupoles to change the beam size and measure it on the BTV screens of the East Area's dump line. The BTVs allows use to measure the position and the beam size as the quadrupoles focuse and defocus the beam. The measurements are then run in MAD-X with different initial conditions to find the ones that match the best. The BTVs aren't very precise, some are very noisy because of there old age and they all saturate at the extraction energy. Filter wheels have been installed and will allows more accurate initial parameter measurement. Additionally, an independent Dispersion measurement will be tried to reduce a degree of freedom.
Also Kick response measurements have been made. Further studies should be performed to verify whether the initial parameters measured in the East Area are similar to those found by tracking through the field maps.

%\textbf{State clearly the efforts we are going to here to measure the beam parameters that come out of the machine and through the stray fields. State the quad scan technique and challenges with lack of instrumentation but that work continues with BTVs and additional of filter wheels for a comparison with simulation}


\section{SUMMARY AND OUTLOOK}
The results of this study indicate that the OPERA model using tracking routines is suitable to characterize stray fields in the PS MU, as it has led to the same conclusions as made by earlier studies in the case of the extraction to the East Area and empirically confirmed through measurements at injection. Some limitations should be considered. First, the straight model of the MU is an approximation of the physical magnet, and second, the lack of shims in the model might not be suitable to fully describe the operational beam. This work will be valuable for CHIMERA during ions runs and provides the backbone to create multipole field components models to the East Area and to the LHC.

% REFERENCES
\printbibliography

\end{document}