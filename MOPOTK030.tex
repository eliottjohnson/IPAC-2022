\documentclass[a4paper,
               %boxit,        % check whether paper is inside correct margins
               %titlepage,    % separate title page
               %refpage       % separate references
               biblatex,     % biblatex is used
               keeplastbox,   % flushend option: not to un-indent last line in References
               %nospread,     % flushend option: do not fill with whitespace to balance columns
               %hyphens,      % allow \url to hyphenate at "-" (hyphens)
               %xetex,        % use XeLaTeX to process the file
               %luatex,       % use LuaLaTeX to process the file
               ]{jacow}
%
% ONLY FOR \footnote in table/tabular
%
\usepackage{pdfpages,multirow,ragged2e} %
%
% CHANGE SEQUENCE OF GRAPHICS EXTENSION TO BE EMBEDDED
% ----------------------------------------------------
% test for XeTeX where the sequence is by default eps-> pdf, jpg, png, pdf, ...
%    and the JACoW template provides JACpic2v3.eps and JACpic2v3.jpg which
%    might generates errors, therefore PNG and JPG first
%
\makeatletter%
	\ifboolexpr{bool{xetex}}
	 {\renewcommand{\Gin@extensions}{.pdf,%
	                    .png,.jpg,.bmp,.pict,.tif,.psd,.mac,.sga,.tga,.gif,%
	                    .eps,.ps,%
	                    }}{}
\makeatother

% CHECK FOR XeTeX/LuaTeX BEFORE DEFINING AN INPUT ENCODING
% --------------------------------------------------------
%   utf8  is default for XeTeX/LuaTeX
%   utf8  in LaTeX only realises a small portion of codes
%
\ifboolexpr{bool{xetex} or bool{luatex}} % test for XeTeX/LuaTeX
 {}                                      % input encoding is utf8 by default
 {\usepackage[utf8]{inputenc}}           % switch to utf8

\usepackage[USenglish]{babel}

%
% if BibLaTeX is used
%
\ifboolexpr{bool{jacowbiblatex}}%
 {%
  \addbibresource{references.bib}
 }{}
\listfiles

%%
%%   Lengths for the spaces in the title
%%   \setlength\titleblockstartskip{..}  %before title, default 3pt
%%   \setlength\titleblockmiddleskip{..} %between title + author, default 1em
%%   \setlength\titleblockendskip{..}    %afterauthor, default 1em

\begin{document}

\title{Beam optics modelling through fringe fields during injection and extraction at the CERN Proton Synchrotron}

\author{E. P. Johnson\thanks{eliott.philippe.johnson@cern.ch}, M. A. Fraser, M. G. Atanasov, Y. Dutheil, E. Oponowicz,\\ CERN, 1211 Geneva 23, Switzerland}
	
\maketitle

%
\begin{abstract}
As the beam is injected and extracted from the CERN Proton Synchrotron (PS), it passes through the fringing magnetic fields of the Main bending Units (MUs). In this study, tracking simulations using field maps created from a 3D magnetic model of the MUs are compared to beam-based measurements made through the fast injection and slow extraction regions. The behavior of the fringe field is characterized, and its implementation in the MAD-X model of the machine is described.
\end{abstract}


\section{Introduction}
When protons and ion beams are injected and extracted into the PS ring, they travel through the nonlinear stray fields produced by the PS MUs. In these regions, an accurate optical model is imperative for the preservation of transverse emittance. Scaling of the model with energy is required as the injection occurs at 2 GeV/c, and the extractions to the East Area and to the Super Proton Sychrotron (SPS) are at 24 GeV/c and 26 GeV/c, respectively. The limitations of the earlier measurements-based models are that they were produced at a single energy. Versatility is also considered as the beam travels through stray fields with different angles, different magnet types, and a nonconstant number of MUs. A new technique for modeling the stray field that relies solely on simulations is presented, considering the proton injection at 2 GeV/c and the extraction at 24 GeV/c to the East Area. This new model will benefit Charm High-energy Ions for Micro Electronics Reliability Assurance (CHIMERA), which aims to use very high-energy heavy-ion beams to study the effect of single event effects on electric, electronic, and electromechanical devices, both for research and industry users.

\section{Field maps}
\subsection{PS Main Units}
The CERN PS uses the strong focusing mechanism for beam convergence. It is composed of 100 combined function main unit magnets that produce dipolar and quadrupolar fields simultaneously. Each magnet is divided into two half-units with gradients of opposite polarity. Half-units are composed of five blocks of either closed blocks that are focusing (F), see Fig.\ref{fig:focusing} or open blocks that are defocusing (D), see Fig.\ref{fig:defocusing}.

\begin{figure}[!htb]
  \centering
  \begin{minipage}[b]{0.45\columnwidth}
    \includegraphics*[width=\textwidth]{MOPOTK030_f1.png}
    \caption{Closed Focusing yoke.}
    \label{fig:focusing}
  \end{minipage}
  \hfill
  \begin{minipage}[b]{0.45\columnwidth}
    \includegraphics*[width=\textwidth]{MOPOTK030_f2.png}
    \caption{Open Defocusing yoke.}
    \label{fig:defocusing}
  \end{minipage}
\end{figure}

There are four types of magnets: R, S, T and U, depending on the arrangement of the half-units (FD or DF) and whether the main coil is on the inside or outside of the ring \cite{steerenberg_fifty_2011}. Additional coils called pole face winding (PFW) and figure-of-eight loop (F8L) are wrapped around the yokes to correct for chromaticity and tune. Although the combined function magnet works well when the beam is in the central orbit, every injection and extraction of the beam travels through at least one MU, which causes noticeable stray field effects. This is a consequence of the PS not being built with straight sections long enough for injection/extraction at high energy and small septum deflection angles, forcing the extracted beam to travel close to the central orbit and through the stray fields of the MUs \cite{risselada_beam_nodate}.

\subsection{The OPERA model}
A model of the PS main units was developed using Cobham's Opera-3D that allows the production of field maps for all four types of magnets and for different currents in the main coils as well as in the PFW and F8L. The model includes the main junction gap of 20 mm (a significant source of fringe field) between the two half units as well as the mini junctions between open blocks of 9.75 mm and 7.75 mm between closed blocks. A plane containing the geometry of open and closed yokes is swept in the longitudinal direction, allowing us to maintain high accuracy of the model, and reduces the computation time.This feature of a single plane also has limitations as it models straight magnets, while real magnets have a curvature. The density of the mesh is adjusted so that it has a high resolution in close proximity to the central orbit and at the junctions to capture the fringe fields \cite{anglada_reference_2019}.

An example of a field map (vector field of Bx, By, Bz in x, y, z space) produced by the Opera model is presented in Fig.\ref{fig:dipole_field}. The transverse displacement of the peak of the vertical dipole field $B_{y}$ along the z-axis corresponds to the switch from one half-unit to the next. The resolution of the field map is high enough to see the mini-junction between the five blocks.

\begin{figure}[!htb]
   \centering
   %trim={<left> <lower> <right> <upper>}
   \includegraphics*[width=1.0\columnwidth, trim={0 2.9cm 0 4.3cm},clip]{MOPOTK030_f3.png}
   \caption{Dipole field map of a U-type magnet centered in the vertical plane at 24 GeV.}
   \label{fig:dipole_field}
\end{figure}

The gradient can be calculated from the dipole field map using the following formula:
 
$$ \boldsymbol{G}(x_{j},z) = \frac{\Delta\boldsymbol{B}}{\Delta x} = \frac{\boldsymbol{B}(x_{i+1},z) - \boldsymbol{B}(x_{i},z)}{x_{i+1}-x_{i}} $$
where,
$$ x_{j} = \frac{x_{i+1} + x_{i}}{{2}} $$
 
The gradient is constant and alternating in the central orbit region, but reverses signs at the periphery and increases in magnitude in a nonlinear way; see Fig.\ref{fig:gradient_field}. Similar results have previously been made using magnetic measurements of MU fields \cite{manglunki_beam_1997}. Earlier models of the stray field for extraction 16 at 26 GeV/c proved to be adequate in the description of operational beams. However, the OPERA model adds the possibility to quickly generate field maps at different energies, different PFW, different F8L settings, and for different magnet types. Field maps produced with the OPERA model also have virtually infinite lengths, while those produced with field measurements were limited by magnet geometry and measuring equipment (-0.07 $\leq$ x $\leq$ 0.31 m and -2.55 $\leq$ z $\leq$ 2.73 m)\cite{manglunki_beam_1997}.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth, trim={0 0 0 0cm},clip]{MOPOTK030_f4.png}
   \caption{Dipole and gradient component of a  PS U-type MU centered in the vertical plane in both half-units at 24 GeV. The gradient outside the central orbit is nonlinear and, at its maximum, is almost three-fold higher in amplitude.}
   \label{fig:gradient_field}
\end{figure}

\subsection{Tracking}
Particle tracking through field maps is done using the Boris algorithm that tracks charged particles in EM-fields using the discretized equation of motion of the Lorentz force\cite{qin_why_2013}\cite{ripperda_comprehensive_2018}. Additionally, the numerical tracking of a number of representative particles allows one to produce transfer matrices that can be implemented in tracking simulations such as MAD-X \cite{yoon_method_2013}.

\section{Beam Tracking}
Field maps have been produced for each magnet type at three different energies: injection at 2 GeV/c with 533 A, slow extraction to the east area at 24 GeV/c with 4642 A, and extraction to the SPS at 26.4 GeV/c with 5386 A. In the following, the injection from the BTP transfer line to the PS and the extraction from the PS to the East Area have been studied.

\subsection{Injection BTP}
As the beam is injected via the BTP transfer line to the PS ring, it passes through the stray fields of the PR.BHT41 T-type MU magnet. The beam traverses mostly through the defocusing half part and feels a nonlinear increase in the gradient up to the nominal value in the central orbit. Once through MU41, the beam is kicked by the PI.SMH42 septum magnet to capture the reference orbit. The beam position can then be measured using the downstream Secondary Emission Grid (SEM Grid) PI.BSG42. Single particle tracking is done by centering the initial beam in the middle of the injection pipe at the GEODE reference points, see Fig. \ref{fig:injection_btp}.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{MOPOTK030_f5.png}
   \caption{Tracking through MU41 T-type, momentum 2 GeV/c, extraction offset 54.684 mm, angle 5.093 degrees. It can be noticed that the field map is straight as opposed to the curved technical drawing.}
   \label{fig:injection_btp}
\end{figure}
Measurements were collected by means of scaling the current in all MUs using theW Power system for PS main magnets (POPS); for our purpose, we only consider MU41, as it is the only magnet through which the beam passes. As expected, an increasing B field shows a decrease in the transverse position of the beam as it is bent closer to the inside of the ring on the SEM-grid. The 2 GeV/c T-type field map is scaled by the same factor as the current, and a single particle is tracked through the field map. The position and angle at the end of the exit of the main unit are saved and inserted in the MAD-X PS lattice up to the SEM-Grid location. For comparison, we review the current implementation of the stray field at injection that consists of a sequence of 235 multipoles K0, K1, K2 and K3 that were created using past measurements. These are scaled by the same factor. The transverse position as a function of the B field at injection closely matches the measurements, although the tracking model performs slightly worse than the multipole model; see Fig. \ref{fig:injection_btp_transverse_position}. This can be due to mumetal (high-permeability) shielding wrapped around the injection vacuum pipe that is not considered in the field map, or due to the fact that the field map is straight instead of being bent and/or a different initial position and angle of the tracked particle. As expected, no deviation is observed in the vertical plane.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{MOPOTK030_f6.png}
   \caption{Measurements of the BT3 BTP PS kick response as a function of POPS compared with the OPERA tracking model and the multipole field coefficient model.}
   \label{fig:injection_btp_transverse_position}
\end{figure}

Furthermore, the current model of the stray field is compared with the components found with tracking. The dipole component is saved along the track, and the quadrupole component is computed using two adjacent tracks with a slight transverse offset at the initial starting point. The OPERA tracking model gives components close to the previous model. The dipole integral of the OPERA model is $8.36\cdot10^{-3}$ Tm, and the multipole field coefficient (MFC) model gives $8.86\cdot10^{-3}$ Tm, which is a difference of 5.63\% compared to the MFC model. The integral of the quadrupole component of the OPERA model is $-6.68\cdot10^{-2}$ T and the MFC is $-7.43\cdot10^{-2}$ T, a 10.03\% difference compared to the MFC model.


\subsection{Extraction to the East Area}
The extraction to the East Area is affected by the stray fields of two main units, MU62 and MU63, a consequence of the beam having higher energy, leaving at a shallower angle than at injection. The beam position and angle upstream of a MAD-X simulation are saved and used as a starting position to track a single particle in MU62. The track follows the extraction beam pipe through MU62 and experiences the effect of both half-units. The stray field effect of the second half-unit is of particular importance; as the beam climbs the gradient hill, it experiences a nonlinear gradient with reverse polarity. This leads to a succession in defocusing gradients instead of having an alternating gradient that converges the beam. As a result, an increase in the horizontal beam size is expected at the exit of MU62. A distribution of particles created using MAD-X parameters is tracked through MU62, which shows the defocusing effect; see Fig. \ref{fig:particle_distribution}. Similar conclusions were drawn by T. Risselada using field measurements \cite{risselada_beam_nodate}.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{MOPOTK030_f7.png}
   \caption{Particle distribution entering MU62 (red) and exiting the MU (blue) following the extraction trajectory.}
   \label{fig:particle_distribution}
\end{figure}

\subsection{Magnetic shims}

To counteract stray fields, magnetic shims (low carbon steel shielding) are installed at ejections 16 and 63 to homogenize the field by shielding the ejected beam from the nonlinear fringe field \cite{zickler_influence_nodate}. In Section 16, the shims have different radial positions for each of the five different shims, whereas in Section 63, the vacuum pipe is covered with a constant rectangular shim. In Section 62, no shims are installed, where the model predicts the most important stray field effect. Field maps produced with the OPERA model do not include the effect of shims, and thus only give a partial description of the actual fields. Adding the shims in the OPERA model is considered but requires considerable rework, as the model takes advantage of a straight geometry, whereas the extraction pipe and shims are at an angle with respect to the main units which would increase the computational time.


\section{CONCLUSION}
The results of this study indicate that the OPERA model using tracking routines is suitable to characterize stray fields in the PS MU, as it has led to the same conclusions as made by earlier studies in the case of the extraction to the East Area and empirically confirmed through measurements at injection. Some limitations should be considered. First, the straight model of the MU is an approximation of the physical magnet, and second, the lack of shims in the model might not be suitable to fully describe the operational beam. This work may be valuable for CHIMERA during ions runs and provides the backbone to implement transfer maps or multipoles in MAD-X. Further studies should be performed to verify whether the initial parameters measured in the East Area are similar to those found by tracking through the field maps.

% REFERENCES
\printbibliography

\end{document}